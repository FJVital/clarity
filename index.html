<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics GA4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BHVQ2LCLZG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BHVQ2LCLZG');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your messy thoughts ‚Üí clear messages, instantly. AI-powered writing assistant that transforms bullet points into professional communication.">
    <meta name="keywords" content="AI writing assistant, message clarity, email writing, professional communication, AI rewriter">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://claritytext.app/">
    <meta property="og:title" content="ClarityText - Your Thoughts, Clearly Said">
    <meta property="og:description" content="Write like you think. AI makes it professional. Never struggle with words again.">
    <meta property="og:image" content="https://claritytext.app/og-image.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://claritytext.app/">
    <meta property="twitter:title" content="ClarityText - Your Thoughts, Clearly Said">
    <meta property="twitter:description" content="Write like you think. AI makes it professional.">
    <meta property="twitter:image" content="https://claritytext.app/og-image.png">
    
    <title>ClarityText - Your Thoughts, Clearly Said</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ú®</text></svg>">
    
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ClarityText">
    <meta name="theme-color" content="#6366F1">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        accent: '#F97316',
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .text-gradient {
            background: linear-gradient(135deg, #6366F1 0%, #F97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-bounce-arrow {
            animation: bounceArrow 2s ease-in-out infinite;
        }
        
        @keyframes bounceArrow {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(10px); }
        }
        
        .transform-text {
            transition: all 0.3s ease;
        }
        
        .demo-input {
            transition: all 0.3s ease;
        }
        
        .demo-input:focus {
            transform: scale(1.01);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
        }
        
        .icon-container img {
            max-width: 80px;
            max-height: 80px;
            object-fit: contain;
        }
        
        .hero-example img {
            border: 2px solid #E5E7EB;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Make demo image more readable on mobile */
        @media (max-width: 768px) {
            .hero-example {
                padding: 1rem !important;
            }
            .hero-example img {
                max-width: 100%;
                height: auto;
                transform: scale(1.1);
                transform-origin: center;
            }
        }
        
        .comparison-table td, .comparison-table th {
            padding: 16px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Additional mobile responsive fixes */
        @media (max-width: 768px) {
            .comparison-table td, .comparison-table th {
                padding: 8px 4px;
                font-size: 11px;
            }
        }
        
        /* Install App button */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            animation: pulse-button 2s infinite;
        }
        
        @keyframes pulse-button {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Modal styles */
        
        /* PRO Badge Styles */
        .paid-badge {
            font-size: 10px;
            line-height: 1;
        }
                .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- PWA Redirect Script v2 - MUST BE FIRST -->
    <script>
        // Detect if running as installed PWA and redirect to app.html
        // This bypasses manifest caching issues by redirecting at runtime
        (function() {
            console.log('[PWA Redirect v2] Script executing...');
            console.log('[PWA Redirect v2] Current URL:', window.location.href);
            console.log('[PWA Redirect v2] Pathname:', window.location.pathname);
            
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true ||
                                document.referrer.includes('android-app://');
                                
            const isIndexPage = window.location.pathname === '/' || 
                               window.location.pathname === '/index.html';
            
            console.log('[PWA Redirect v2] isStandalone:', isStandalone);
            console.log('[PWA Redirect v2] isIndexPage:', isIndexPage);
            
            // Only redirect if:
            // 1. Running as PWA (standalone)
            // 2. Currently on index/home page
            // 3. Not already on app.html
            if (isStandalone && isIndexPage) {
                console.log('[PWA Redirect v2] ‚úÖ Redirecting to /app.html');
                window.location.replace('/app.html');
            } else {
                console.log('[PWA Redirect v2] ‚ùå Not redirecting');
            }
        })();
    </script>
    
    <!-- Install App Button (Floating) -->
    <button id="install-button" class="install-button hidden bg-primary text-white px-6 py-3 rounded-full font-semibold shadow-2xl hover:bg-indigo-700 transition">
        üì± Install App
    </button>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">‚ú®</span>
                    <span class="text-xl font-bold text-primary">ClarityText</span>
                </div>
                
                <!-- User Status -->
                <div class="flex items-center gap-4">
                    <!-- Show when NOT logged in -->
                    <div id="logged-out-nav" class="flex items-center gap-4">
                        <a href="#demo" class="text-gray-700 hover:text-primary transition font-medium">Try Free</a>
                        <a href="#pricing" class="text-gray-700 hover:text-primary transition font-medium">Pricing</a>
                        <button onclick="showSignupModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-semibold">
                            Sign Up
                        </button>
                    </div>
                    
                    <!-- Show when logged in -->
                    <div id="logged-in-nav" class="hidden flex items-center gap-4">
                        <span id="nav-user-email" class="text-sm text-gray-600"></span>
                        <a href="/app.html" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-semibold">
                            Open App
                        </a>
                        <button onclick="handleNavLogout()" class="text-gray-700 hover:text-primary transition font-medium">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="py-20 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-6">
                Your Thoughts,<br>
                <span class="text-gradient">Clearly Said</span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-600 mb-8 max-w-2xl mx-auto">
                Write like you think. AI makes it professional.<br>
                Never struggle with words again.
            </p>
            
            <!-- Three Buttons - Equal Size -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mb-12 max-w-2xl mx-auto">
                <a href="/app.html" class="flex-1 bg-primary text-white px-8 py-4 rounded-xl hover:bg-indigo-700 transition font-bold text-lg shadow-lg hover:shadow-xl hover:-translate-y-1">
                    Open App
                </a>
                <button onclick="handleHeroInstall()" class="flex-1 bg-accent text-white px-8 py-4 rounded-xl hover:bg-orange-700 transition font-bold text-lg shadow-lg hover:shadow-xl hover:-translate-y-1">
                    Install PWA
                </button>
                <button onclick="scrollToDemo()" class="flex-1 border-2 border-primary text-primary px-8 py-4 rounded-xl hover:bg-indigo-50 transition font-bold text-lg">
                    Try Demo
                </button>
            </div>
            
            <!-- Hero Example/Demo Image -->
            <div class="hero-example bg-white rounded-2xl shadow-2xl p-8 max-w-3xl mx-auto">
                <img src="/input_output.png" alt="ClarityText Demo" class="w-full rounded-lg">
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="py-16 px-4 bg-white">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-900 mb-12">
                Why ClarityText?
            </h2>
            
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Feature 1 -->
                <div class="text-center hover-lift bg-gray-50 p-6 rounded-xl">
                    <div class="text-5xl mb-4">‚ö°</div>
                    <h3 class="text-xl font-bold mb-3 text-gray-900">Instant Transformation</h3>
                    <p class="text-gray-600" style="font-size: 20px;">
                        Brain dump your messy thoughts. Get polished messages in seconds.
                    </p>
                </div>
                
                <!-- Feature 2 -->
                <div class="text-center hover-lift bg-gray-50 p-6 rounded-xl">
                    <div class="text-5xl mb-4">üéØ</div>
                    <h3 class="text-xl font-bold mb-3 text-gray-900">7 Powerful Styles</h3>
                    <p class="text-gray-600" style="font-size: 20px;">
                        Professional, persuasive, casual, direct, email, enthusiastic, or empathetic.
                    </p>
                </div>
                
                <!-- Feature 3 -->
                <div class="text-center hover-lift bg-gray-50 p-6 rounded-xl">
                    <div class="text-5xl mb-4">üß†</div>
                    <h3 class="text-xl font-bold mb-3 text-gray-900">Powered by Claude Sonnet 4</h3>
                    <p class="text-gray-600" style="font-size: 20px;">
                        State-of-the-art AI understands context and nuance.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Interactive Demo Section -->
    <section id="demo" class="py-16 px-4 bg-gray-50">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-900 mb-4">
                Try It Now - Free
            </h2>
            <p id="demo-subtitle" class="text-center text-gray-600 mb-8">
                2 free transformations remaining (no signup needed)
            </p>
            
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <!-- Input -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Your messy thoughts:
                    </label>
                    <textarea 
                        id="demo-input"
                        class="demo-input w-full h-32 p-4 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none text-sm resize-none"
                        placeholder="Example: need report done, john's numbers missing, deadline friday, tell everyone meet thursday 3pm review"></textarea>
                </div>
                
                <!-- Style Selector -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Choose style:</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onclick="selectDemoStyle('professional')" 
                                class="demo-style-btn px-4 py-3 border-2 border-primary bg-primary text-white rounded-lg hover:bg-primary/90 transition font-medium text-sm" 
                                data-style="professional">
                            Professional
                        </button>
                        <button onclick="selectDemoStyle('direct')" 
                                class="demo-style-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-indigo-50 transition font-medium text-sm" 
                                data-style="direct">
                            Direct
                        </button>
                        <button onclick="selectDemoStyle('email')" 
                                class="demo-style-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-indigo-50 transition font-medium text-sm" 
                                data-style="email">
                            Email
                        </button>
                        <button onclick="selectDemoStyle('casual')" 
                                class="demo-style-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-indigo-50 transition font-medium text-sm" 
                                data-style="casual">
                            Casual
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">* 4 more styles available in paid plans</p>
                </div>
                
                <!-- Transform Button -->
                <button 
                    id="demo-transform-btn"
                    onclick="transformDemoMessage()"
                    class="w-full bg-primary text-white py-4 rounded-lg hover:bg-indigo-700 transition font-bold text-lg shadow-lg">
                    Transform Message ‚ú®
                </button>
                
                <!-- Output (hidden by default) -->
                <div id="demo-output" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-semibold text-gray-700">
                            Transformed result:
                        </label>
                        <button 
                            id="copy-btn"
                            class="text-sm bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg transition font-medium">
                            Copy to Clipboard
                        </button>
                    </div>
                    <div id="output-content" class="p-4 bg-gray-50 border-2 border-gray-300 rounded-lg text-sm whitespace-pre-wrap"></div>
                </div>
            </div>
            
            <!-- CTA after demo -->
            <div class="text-center mt-8">
                <p class="text-gray-600 mb-4">Want more? Sign up for 2 free rewrites daily.</p>
                <button onclick="showSignupModal()" class="bg-accent text-white px-8 py-3 rounded-lg hover:bg-orange-700 transition font-bold text-lg shadow-lg">
                    Sign Up Free
                </button>
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="py-16 px-4 bg-white">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-900 mb-4">
                Simple, Transparent Pricing
            </h2>
            <p class="text-center text-gray-600 mb-12">
                Start free. Upgrade when you need more.
            </p>
            
            <!-- Pricing Table -->
            <div class="overflow-x-auto">
                <table class="comparison-table w-full border-collapse bg-white shadow-xl rounded-xl overflow-hidden">
                    <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                        <tr>
                            <th class="text-left p-4 font-bold">Feature</th>
                            <th class="p-4 font-bold">Free</th>
                            <th class="p-4 font-bold bg-primary/20">Standard</th>
                            <th class="p-4 font-bold">Pro</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-semibold">Price</td>
                            <td class="p-4 text-center">$0</td>
                            <td class="p-4 text-center bg-indigo-50 font-bold text-primary">$9/mo</td>
                            <td class="p-4 text-center font-bold text-accent">$15/mo</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-semibold">Rewrites per day</td>
                            <td class="p-4 text-center">2</td>
                            <td class="p-4 text-center bg-indigo-50 font-bold">10</td>
                            <td class="p-4 text-center font-bold">20</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-semibold">Free styles</td>
                            <td class="p-4 text-center">3</td>
                            <td class="p-4 text-center bg-indigo-50">7</td>
                            <td class="p-4 text-center">7</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-semibold">Pro styles</td>
                            <td class="p-4 text-center">‚ùå</td>
                            <td class="p-4 text-center bg-indigo-50">‚úÖ</td>
                            <td class="p-4 text-center">‚úÖ</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-semibold">Best for</td>
                            <td class="p-4 text-center text-sm">Testing</td>
                            <td class="p-4 text-center bg-indigo-50 text-sm font-semibold">Regular users</td>
                            <td class="p-4 text-center text-sm font-semibold">Power users</td>
                        </tr>
                        <tr>
                            <td class="p-4"></td>
                            <td class="p-4 text-center">
                                <button onclick="showSignupModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition font-semibold">
                                    Sign Up
                                </button>
                            </td>
                            <td class="p-4 text-center bg-indigo-50">
                                <button onclick="showSignupModal()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-semibold shadow-lg">
                                    Get Started
                                </button>
                            </td>
                            <td class="p-4 text-center">
                                <button onclick="showSignupModal()" class="bg-accent text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition font-semibold shadow-lg">
                                    Get Started
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <div class="flex items-center justify-center gap-2 mb-4">
                <span class="text-2xl">‚ú®</span>
                <span class="text-xl font-bold">ClarityText</span>
            </div>
            <p class="text-gray-400 mb-4">Your thoughts, clearly said. Powered by Claude Sonnet 4.</p>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 text-sm text-gray-400">
                <a href="mailto:hello@claritytext.app" class="hover:text-white transition">hello@claritytext.app</a>
                <span class="hidden sm:inline">‚Ä¢</span>
                <span>¬© 2025 ClarityText. All rights reserved.</span>
            </div>
        </div>
    </footer>

    <!-- Signup/Login Modal (same as before, unchanged) -->
    <div id="auth-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0" onclick="hideSignupModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 relative z-10">
            <button onclick="hideSignupModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">
                √ó
            </button>
            
            <h2 id="modal-title" class="text-2xl font-bold text-gray-900 mb-2">Sign Up for Free</h2>
            <p class="text-gray-600 mb-6">Get 2 free transformations daily</p>
            
            <!-- Signup Form -->
            <div id="signup-form">
                <input 
                    type="email" 
                    id="signup-email"
                    placeholder="your@email.com"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg mb-3 focus:border-primary focus:outline-none">
                <input 
                    type="password" 
                    id="signup-password"
                    placeholder="Password (min 6 characters)"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-primary focus:outline-none">
                <button 
                    onclick="handleSignup()"
                    class="w-full bg-primary text-white py-3 rounded-lg hover:bg-indigo-700 transition font-bold mb-3">
                    Sign Up Free
                </button>
                <p class="text-center text-sm text-gray-600">
                    Already have an account? 
                    <button onclick="switchToLogin()" class="text-primary hover:underline font-semibold">
                        Log in
                    </button>
                </p>
            </div>
            
            <!-- Login Form (hidden by default) -->
            <div id="login-form" class="hidden">
                <input 
                    type="email" 
                    id="login-email"
                    placeholder="your@email.com"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg mb-3 focus:border-primary focus:outline-none">
                <input 
                    type="password" 
                    id="login-password"
                    placeholder="Password"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-primary focus:outline-none">
                <button 
                    onclick="handleLogin()"
                    class="w-full bg-primary text-white py-3 rounded-lg hover:bg-indigo-700 transition font-bold mb-3">
                    Log In
                </button>
                <p class="text-center text-sm text-gray-600">
                    Don't have an account? 
                    <button onclick="switchToSignup()" class="text-primary hover:underline font-semibold">
                        Sign up
                    </button>
                </p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ============================================
        // SUPABASE INITIALIZATION
        // ============================================
        
        const SUPABASE_URL = 'https://ieeujkkggjufhmztvdyr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllZXVqa2tnZ2p1ZmhtenR2ZHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIyMjc5NjYsImV4cCI6MjA0NzgwMzk2Nn0.JBsmz7RHtVQBIIOIOo-_Ls8fzMOXA-L6ZgwF69F0XtQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let userTier = 'free';
        
        // ============================================
        // AUTH STATE MANAGEMENT
        // ============================================
        
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                
                // Load user data from database
                await loadUserData();
                
                // Update UI for logged in state
                document.getElementById('logged-out-nav').classList.add('hidden');
                document.getElementById('logged-in-nav').classList.remove('hidden');
                document.getElementById('nav-user-email').textContent = currentUser.email;
            } else {
                // Not logged in
                document.getElementById('logged-out-nav').classList.remove('hidden');
                document.getElementById('logged-in-nav').classList.add('hidden');
            }
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (data) {
                userTier = data.tier;
            }
        }
        
        async function handleNavLogout() {
            await supabase.auth.signOut();
            window.location.reload();
        }
        
        // ============================================
        // MODAL MANAGEMENT
        // ============================================
        
        function showSignupModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
        }
        
        function hideSignupModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }
        
        function switchToLogin() {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('modal-title').textContent = 'Log In';
        }
        
        function switchToSignup() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('modal-title').textContent = 'Sign Up for Free';
        }
        
        // ============================================
        // AUTH HANDLERS
        // ============================================
        
        async function handleSignup() {
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });
                
                if (error) throw error;
                
                // Track signup in GA4
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'sign_up', {
                        method: 'email'
                    });
                }
                
                alert('Signup successful! Check your email to verify your account.');
                hideSignupModal();
                
            } catch (error) {
                alert('Signup error: ' + error.message);
            }
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                
                if (error) throw error;
                
                alert('Login successful!');
                hideSignupModal();
                window.location.reload();
                
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }
        
        // ============================================
        // DEMO SECTION LOGIC
        // ============================================
        
        let demoSelectedStyle = 'professional';
        let rewritesRemaining = 2; // Anonymous users get 2 free
        
        function selectDemoStyle(style) {
            demoSelectedStyle = style;
            
            // Update button styles
            document.querySelectorAll('.demo-style-btn').forEach(btn => {
                if (btn.dataset.style === style) {
                    btn.classList.add('border-primary', 'bg-primary', 'text-white');
                    btn.classList.remove('border-gray-300');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary', 'text-white');
                    btn.classList.add('border-gray-300');
                }
            });
        }
        
        // Check if user has used their free transformations (localStorage tracking for non-logged-in users)
        function checkFreeUsage() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('claritytext_free_usage');
            
            if (stored) {
                const data = JSON.parse(stored);
                if (data.date === today) {
                    rewritesRemaining = Math.max(0, 2 - data.count);
                } else {
                    // New day, reset
                    localStorage.setItem('claritytext_free_usage', JSON.stringify({ date: today, count: 0 }));
                    rewritesRemaining = 2;
                }
            } else {
                localStorage.setItem('claritytext_free_usage', JSON.stringify({ date: today, count: 0 }));
                rewritesRemaining = 2;
            }
            
            updateDemoSubtitle();
        }
        
        function incrementFreeUsage() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('claritytext_free_usage');
            
            if (stored) {
                const data = JSON.parse(stored);
                if (data.date === today) {
                    data.count++;
                    localStorage.setItem('claritytext_free_usage', JSON.stringify(data));
                }
            }
        }
        
        async function transformDemoMessage() {
            const input = document.getElementById('demo-input').value.trim();
            
            if (!input) {
                alert('Please enter some text to transform');
                return;
            }
            
            // Check if user is logged in
            if (!currentUser) {
                // Check free usage limit
                if (rewritesRemaining <= 0) {
                    alert('You\'ve used your 2 free transformations today! Sign up to get 2 free transformations daily.');
                    showSignupModal();
                    return;
                }
            } else if (userTier === 'free') {
                // For logged-in free users, check their database limit
                await loadUserData();
                if (rewritesRemaining <= 0) {
                    alert('Daily limit reached! Upgrade to Standard or Pro for more rewrites.');
                    return;
                }
            }
            
            const transformBtn = document.getElementById('demo-transform-btn');
            const demoOutput = document.getElementById('demo-output');
            const outputContent = document.getElementById('output-content');
            
            transformBtn.innerHTML = '‚è≥ Transforming...';
            transformBtn.disabled = true;
            
            try {
                // Get session token if logged in
                let token = null;
                if (currentUser) {
                    const { data: { session } } = await supabase.auth.getSession();
                    token = session?.access_token;
                }
                
                const response = await fetch('/api/rewrite.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` })
                    },
                    body: JSON.stringify({
                        text: input,
                        style: demoSelectedStyle
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Transformation failed');
                }
                
                const data = await response.json();
                
                // Format output (preserve line breaks and bullet points)
                function formatOutput(text) {
                    const lines = text.split('\n');
                    let inList = false;
                    let formatted = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        
                        // Check if line is a bullet point
                        if (line.trim().match(/^[-*]\s/)) {
                            if (!inList) {
                                formatted.push('<ul class="list-disc ml-6 my-2">');
                                inList = true;
                            }
                            const content = line.trim().substring(2); // Remove "- " or "* "
                            formatted.push(`<li>${content}</li>`);
                        } else {
                            if (inList) {
                                formatted.push('</ul>');
                                inList = false;
                            }
                            if (line.trim()) {
                                formatted.push(line);
                            } else {
                                // Skip empty lines for single-spacing
                            }
                        }
                    }
                    
                    if (inList) {
                        formatted.push('</ul>');
                    }
                    
                    return formatted.join('<br>');
                }
                
                // Display result
                outputContent.innerHTML = formatOutput(data.result);
                demoOutput.classList.remove('hidden');
                demoOutput.classList.add('fade-in');
                
                // Update usage
                if (!currentUser) {
                    rewritesRemaining--;
                } else {
                    await loadUserData();
                }
                
                updateDemoSubtitle();
                
                // Scroll to output
                demoOutput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } catch (error) {
                console.error('Error:', error);
                alert('Sorry, there was an error: ' + error.message);
            } finally {
                transformBtn.innerHTML = 'Transform Message';
                transformBtn.disabled = false;
            }
        }
        
        function updateDemoSubtitle() {
            if (!currentUser) {
                document.getElementById('demo-subtitle').textContent = 
                    rewritesRemaining > 0 
                        ? `${rewritesRemaining} free transformation${rewritesRemaining !== 1 ? 's' : ''} remaining` 
                        : 'Sign up for 2 free rewrites daily';
            } else if (userTier === 'free') {
                document.getElementById('demo-subtitle').textContent = `${rewritesRemaining} rewrites remaining today`;
            }
        }
        
        // Copy to clipboard
        document.getElementById('copy-btn')?.addEventListener('click', function() {
            const text = document.getElementById('output-content').innerText;
            navigator.clipboard.writeText(text).then(() => {
                this.innerHTML = '‚úì Copied!';
                setTimeout(() => {
                    this.innerHTML = 'Copy to Clipboard';
                }, 2000);
            });
        });
        
        // Handle upgrade button click
        function handleUpgradeClick() {
            if (!currentUser) {
                showSignupModal();
            } else {
                alert('Stripe integration coming soon! Email hello@claritytext.app to upgrade.');
            }
        }
        
        // Scroll to demo
        function scrollToDemo() {
            document.getElementById('demo').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ============================================
        // SMOOTH SCROLLING
        // ============================================
        
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                const href = this.getAttribute('href');
                if (href === '#' || href.startsWith('#')) {
                    const target = document.querySelector(href === '#' ? 'body' : href);
                    if (target) {
                        e.preventDefault();
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        });
        
        // ============================================
        // INITIALIZE ON PAGE LOAD
        // ============================================
        
        checkAuth();
        
        // Set default style button
        document.querySelector('.demo-style-btn').click();
        
        // ============================================
        // PWA INSTALL PROMPT HANDLER - ENHANCED
        // ============================================
        
        let deferredPrompt;
        const installButton = document.getElementById("install-button"); // Floating button
        
        // Handle hero install button click - Direct navigation to app
        window.handleHeroInstall = function() {
            window.location.href = '/app.html?source=pwa';
        };
        
        // Capture the beforeinstallprompt event
        window.addEventListener("beforeinstallprompt", (e) => {
            console.log('beforeinstallprompt event fired');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show floating install button
            if (installButton) {
                installButton.classList.remove("hidden");
            }
        });
        
        // Handle floating install button
        if (installButton) {
            installButton.addEventListener("click", async () => {
                if (!deferredPrompt) {
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`Floating button install: ${outcome}`);
                deferredPrompt = null;
                installButton.classList.add("hidden");
            });
        }
        
        // Handle app installed event
        window.addEventListener("appinstalled", () => {
            console.log("PWA was installed successfully!");
            if (installButton) {
                installButton.classList.add("hidden");
            }
        });
        
        // SERVICE WORKER REGISTRATION (PWA)
        // ============================================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('‚úÖ ServiceWorker registered:', registration);
                        
                        // Check for updates every time the page loads
                        registration.update();
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîÑ New service worker found, installing...');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('‚úÖ New service worker installed! Reloading page...');
                                    // New service worker available, reload the page
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('‚ùå ServiceWorker registration failed:', error);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
        
    </script>
    
</body>
</html>
