<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClarityText PWA Diagnostics</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            background: #252526;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #007acc;
        }
        .check-pass { color: #4ec9b0; }
        .check-fail { color: #f48771; }
        .check-warn { color: #dcdcaa; }
        h1, h2 { color: #4ec9b0; }
        code {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <h1>üîç ClarityText PWA Diagnostics</h1>
    
    <div class="section">
        <h2>Current Environment</h2>
        <div id="env-checks"></div>
    </div>
    
    <div class="section">
        <h2>PWA Detection</h2>
        <div id="pwa-checks"></div>
    </div>
    
    <div class="section">
        <h2>Service Worker Status</h2>
        <div id="sw-checks"></div>
    </div>
    
    <div class="section">
        <h2>Manifest Status</h2>
        <div id="manifest-checks"></div>
    </div>
    
    <div class="section">
        <h2>Actions</h2>
        <button onclick="testRedirect()">Test Redirect Logic</button>
        <button onclick="clearEverything()">Clear All Data</button>
        <button onclick="window.location.reload()">Reload Page</button>
    </div>

    <script>
        // Run diagnostics
        function runDiagnostics() {
            checkEnvironment();
            checkPWAMode();
            checkServiceWorker();
            checkManifest();
        }

        function checkEnvironment() {
            const div = document.getElementById('env-checks');
            const checks = [];
            
            checks.push(`<div>URL: <code>${window.location.href}</code></div>`);
            checks.push(`<div>Pathname: <code>${window.location.pathname}</code></div>`);
            checks.push(`<div>User Agent: <code>${navigator.userAgent.substring(0, 80)}...</code></div>`);
            
            div.innerHTML = checks.join('');
        }

        function checkPWAMode() {
            const div = document.getElementById('pwa-checks');
            const checks = [];
            
            // Check display mode
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            checks.push(`<div class="${isStandalone ? 'check-pass' : 'check-fail'}">
                ${isStandalone ? '‚úì' : '‚úó'} Display Mode: ${isStandalone ? 'Standalone (PWA)' : 'Browser'}
            </div>`);
            
            // Check navigator.standalone (iOS)
            const navStandalone = window.navigator.standalone;
            checks.push(`<div class="${navStandalone ? 'check-pass' : 'check-warn'}">
                ${navStandalone ? '‚úì' : '‚óã'} navigator.standalone: ${navStandalone ? 'true (iOS PWA)' : 'false/undefined'}
            </div>`);
            
            // Check referrer
            const referrer = document.referrer;
            const isAndroidApp = referrer.includes('android-app://');
            checks.push(`<div class="${isAndroidApp ? 'check-pass' : 'check-warn'}">
                ${isAndroidApp ? '‚úì' : '‚óã'} Referrer: ${referrer || '(empty)'}
            </div>`);
            
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const source = urlParams.get('source');
            checks.push(`<div class="${source === 'pwa' || source === 'shortcut' ? 'check-pass' : 'check-warn'}">
                ${source ? '‚úì' : '‚óã'} Source param: ${source || '(none)'}
            </div>`);
            
            // Overall assessment
            const isPWA = isStandalone || navStandalone || isAndroidApp || source === 'pwa' || source === 'shortcut';
            checks.push(`<div class="${isPWA ? 'check-pass' : 'check-fail'}" style="margin-top: 10px; font-weight: bold;">
                ${isPWA ? '‚úÖ RUNNING AS PWA' : '‚ùå RUNNING AS BROWSER'}
            </div>`);
            
            div.innerHTML = checks.join('');
        }

        async function checkServiceWorker() {
            const div = document.getElementById('sw-checks');
            const checks = [];
            
            if ('serviceWorker' in navigator) {
                checks.push(`<div class="check-pass">‚úì Service Worker API Available</div>`);
                
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        checks.push(`<div class="check-pass">‚úì Service Worker Registered</div>`);
                        
                        if (registration.active) {
                            checks.push(`<div class="check-pass">‚úì Active Worker: ${registration.active.scriptURL}</div>`);
                        }
                        
                        if (registration.waiting) {
                            checks.push(`<div class="check-warn">‚ö† Waiting Worker: Update available</div>`);
                        }
                        
                        if (registration.installing) {
                            checks.push(`<div class="check-warn">‚ö† Installing Worker: Update in progress</div>`);
                        }
                    } else {
                        checks.push(`<div class="check-fail">‚úó No Service Worker Registered</div>`);
                    }
                } catch (err) {
                    checks.push(`<div class="check-fail">‚úó Error checking Service Worker: ${err.message}</div>`);
                }
            } else {
                checks.push(`<div class="check-fail">‚úó Service Worker API Not Available</div>`);
            }
            
            div.innerHTML = checks.join('');
        }

        async function checkManifest() {
            const div = document.getElementById('manifest-checks');
            const checks = [];
            
            // Check manifest link
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                checks.push(`<div class="check-pass">‚úì Manifest link found: <code>${manifestLink.href}</code></div>`);
                
                // Try to fetch manifest
                try {
                    const response = await fetch(manifestLink.href);
                    if (response.ok) {
                        const manifest = await response.json();
                        checks.push(`<div class="check-pass">‚úì Manifest loaded successfully</div>`);
                        checks.push(`<div>Name: <code>${manifest.name}</code></div>`);
                        checks.push(`<div>Start URL: <code>${manifest.start_url}</code></div>`);
                        checks.push(`<div>Display: <code>${manifest.display}</code></div>`);
                        checks.push(`<div>Icons: ${manifest.icons?.length || 0} defined</div>`);
                    } else {
                        checks.push(`<div class="check-fail">‚úó Failed to load manifest: ${response.status}</div>`);
                    }
                } catch (err) {
                    checks.push(`<div class="check-fail">‚úó Error loading manifest: ${err.message}</div>`);
                }
            } else {
                checks.push(`<div class="check-fail">‚úó No manifest link found in HTML</div>`);
            }
            
            div.innerHTML = checks.join('');
        }

        function testRedirect() {
            console.log('=== TESTING REDIRECT LOGIC ===');
            
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                              || window.navigator.standalone
                              || document.referrer.includes('android-app://');
            
            const urlParams = new URLSearchParams(window.location.search);
            const isPWASource = urlParams.get('source') === 'pwa' || urlParams.get('source') === 'shortcut';
            
            const shouldRedirect = (isStandalone || isPWASource) && !window.location.pathname.includes('app.html');
            
            console.log('isStandalone:', isStandalone);
            console.log('isPWASource:', isPWASource);
            console.log('shouldRedirect:', shouldRedirect);
            
            if (shouldRedirect) {
                console.log('Would redirect to: /app.html?source=pwa');
                if (confirm('Redirect to app.html now?')) {
                    window.location.replace('/app.html?source=pwa');
                }
            } else {
                console.log('Would NOT redirect');
                alert('Based on current state, redirect would NOT happen.\n\nCheck console for details.');
            }
        }

        async function clearEverything() {
            if (!confirm('This will clear ALL site data and service workers. Continue?')) {
                return;
            }
            
            // Unregister service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                    console.log('Unregistered service worker');
                }
            }
            
            // Clear caches
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    console.log('Deleted cache:', cacheName);
                }
            }
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            
            alert('All data cleared! Reloading page...');
            window.location.reload(true);
        }

        // Run diagnostics on load
        window.addEventListener('load', runDiagnostics);
        
        // Auto-refresh every 5 seconds
        setInterval(runDiagnostics, 5000);
    </script>
</body>
</html>